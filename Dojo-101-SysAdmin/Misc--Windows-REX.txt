Role AD:
Controleur de domaine
PdC (synchro heure)
Global-Catalog (contient tout les objects des domaines AD)
RID (gere les Security ID)
Infrastructure master (unicit� des noms)

installation WindowsServer2008:
	- installer les services Active Directory depuis start\administration tools\Server Manager
	 "Actives directory services" pour les outils AD
	- installer la gpmc : start\administration tools\Server Manager\features\addfeatures

	
D�ploiment machine virtuelle:
	 - verifier nom et ip dispo
	 - prendre un template, changer le nom des la premiere fenetre
	 - selectionner une config wizzard �xistante et ne pas changer le mot de passe admin.
	 - verifier que le switch puisse se connecter au domaine avant de lancer la VM
	 - d�ployer dans oper/fab -> 
			ne pas cr�er sur un local store
			ne pas cr�er sur un projet (ex: c2store + projet + baie)
			toujours laisser 10% du store 
			choisir un nom c2store + baie
	 - Activer le remote desktop
	 - mettre a jour VMWare tools
	 - installer anti-virus (SEP / trend)
	 - Mise a jour windows: executer cscript c:\updatehf2.vbs avec la commande:
		cscript updatehf2.vbs action:install restart:1 mode:silent
			si non: wuauclt /detectnow
			rsop.msc permet de voir les mises a jour
	 - Ecrire le nom du projet: domaine: manuf ou site + nom de l'appli
	 - TAG tsmve
	 - SUR ST AJOUTER CROADMINS au groupe administrators

Verifier si nom machine dispo:
	- AD
	- DNS
	- remote desktop

Demande de backup
		ticket remedy + formulaire de "monbackup.cro.st.com"
	

Verifier si une IP est dispo:
	-zone forward du serveur DNS (cocher Associated pointer pour cr�er automatiquement dans la reverse)
	-ping et nslokup (zone reverse DNS)
	-remote desktop (au cas ou firewall empeche reponse ICMP)

	
Moyen d'acces � distance:
	-remote desktop
	-winRM
	-Console

	
Controle d'acces distant:
	-GPO
	-local policy
	-droits share 
	-droits NTFS
	-Firewall


faire un audit:
	- GPO:Computer Configuration / Policies / Windows Settings / Security Settings / Local Policies / Audit Policy 
	- local policy
	- propriet� de l'objet / s�curit� /audits
	
Outils de commande � distance:

	winrm
	psexec
	dameware
	vnc

	
Ajouter un user d'un autre domaine dans un groupe:
	- onglet "General" des propriet�s du groupe: pass� le groupe � "universal" puis "domain local"
	
Attribuer un privilege � un user:
	- Strat�gie de s�curit� du contr�leur de domaine -> Param�tres de s�curit�/Strat�gies locales/Attribution des droits d'utilisateurs


	
Commande net use pour monter un lecteur partag� en local:
	net use Y: \\serveur\dossier-public  passwd /user:domaine\account /PERSISTENT:YES
	passwd peut etre remplac� par * pour cacher le mot de passe qui sera demand�


Commande pour creer un partage:
	- net share myshare=C:\Users\Myname
	
	
Ajouter un script au d�marrage:
	- dans les GPO: computer configuration -> windows setting -> script 
	
	- Tous les programmes pr�sents dans l'onglet d�marrage de MSconfig sont inscrits dans votre base de registre dans les cl�s :
		HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run 
		HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce 
		HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServices
		
	- taskscheduler: d�clanch� au logon
		
BackUp:
	Installation 2008Server:
		ServerManagement -> features -> add -> server backup
			il faut faire une backup complate, dans l'onglet confirmation la mention "bare metal recovery"

		
	Installation 2003Server:
		start -> run -> "ntbackup"
			il faut d�coch� "always wizzard mode" pour faire une backup ASR
		la backup/recovery n�cessitera une disqette
		
Recovery (state, ASR):

	2003Server
		- Depuis le cd d'install /iso avec disquette + acces � la backup (presser F2 apres boot sur disque)
		- depuis l'OS en safe mod (F8) pour r�staurer des fichiers =! systemes
		- depuis l'OS uniquement pour r�staurer des utilisateurs 
		
		
	2008Server (bare metal recovery)
		- depuis le cd d'install /iso + acc�s � la backup
		- depuis l'option "repair computer" (F8 depuis boot loader)
		- depuis l'OS avec option safe mode il faut d�marrer les services wbengine, bds et vss
		- depuis l'OS d�marr� avec option directory recovery (proche du safe mode)
		- depuis l'OS uniquement pour r�staurer des fichiers =! systemes

		
Connaitre le groupe d'un users:

	dsquery user -name "michael vacarella" | dsget user -memberof -expand |findstr /I croadmins
	
Lister les user d'un group 

	dsquery group -name "group" | dsget group -members -expand
		
Taches planifi�es:

	2003Server
		- control panel -> Scheduled Task
	
	2008Server
		- computer management -> scheduled task
		
	ajouter une taches planifi� a distance: schtasks /create /?
		- exemenple: 
		schtasks /craete /s IP /u domain\user /p * /SC onlogon /tn NonDeMaTask /tr c:\windows\system32\cacl.exe
		schtasks /create /ru admav /rp * /sc Weekly /d mon /tn IT_backup /tr c:\it_backup\scripts\backup.bat
		schtasks /create /ru admav /rp * /sc Weekly /d mon /st 09:00:00  /tn Autopurge /tr c:\Autopurge\autopurge.bat
	
Configurer IP avec netsh:
	- Netsh interface ip add address � local area connection � 10.18.155.xx 255.255.255.0
	- Netsh interface ip add address � local area connection � gateway=10.18.155.1 gwmetric=1
	
Teaming/Biding NIC (mettre plusieur carte reseaux en redondance:)
	-sur ILO installer l'outils HP Network Config Utility est teamer les carte depuis l'utilitaire
		- attention l'utilitaire ne d�marre pas si les cartes sont d�ja configur� (adresse static etc...)
		- dans properties ->teaming controls choisir Network Fault Tolerance Only (NFT)
	pour windows 2012 aller dans le server manager, et configurer en mode: active/stanby
		
Lier un groupe de machine sur un Cluster:

	- sur le cluster: edit setting -> DRS
	- chaque groupe correspond � une salle, il faut r�partir les VM entres ses groupes pour assurer une redondance.
	- ATTENTION il faut s'assurer que la VM soit d�ja sur le bon datastore avec de lui attribuer un groupe (la migration ne seras pas automatiqe)

Voir qui est connecter en RDP sur une machine depuis l'AD:

	Outils d'administration > Remote Desktop service Manager
	
	
Notes Divers:
	trunk = mutliplexage de vlan, 802.1Q
	Pour St.com: ajouter le groupe cro-admins
	depuis windows7 le desktop de allusers est un raccourci de public\desktop
	EXCEL: \\localrep.cro.st.com\Packrep\Productivity\OfficeSTD 
	la GPO Restricted groups REMPLACE les users et groups sur la machine ou la GPO est appliqu�
	
	
Verifier qu'un compte existe sur une machine:

	Net use \\qfast01\IPC$ /user:admav ---> le partage administratif IPC$
	
	null session:
	net use \\target\ipc$ "" /user:""
	
Recuperer la Poubelle:
	c:\$recycle.bin
	
Fermer une sessions en batch:

	query session
	tsdiscon


Etendue des groupe:	
	
	Local ou domaine : 
	Utilisable uniquement dans le domaine local. Un groupe avec une �tendue de domaine peut contenir des groupes locaux, globaux ou universels.	
	Ils sont �galement utilisables sur des machines membres du domaine.
	
	Global :
	Un groupe global peut �tre int�gr� dans tous les domaines approuv�s quelques en soit la nature (Domaine Active Directory, Domaine WINNT,
	autres for�ts�). Un groupe global ne peut contenir que des objets du domaine.

	Universel :
	Un groupe universel peut contenir des membres de n�importe quel domaine de la for�t et �tre utilis� dans tout domaine de la for�t. 
	La particularit� des groupes universels est qu�ils sont stock�s directement sur le catalogue global cependant seulement s�ils sont de type s�curit�.

changement de version Windows:
	
	dism /online /set-edition:serverenterprise /productkey:489J6-VHDMP-X63PK-3K798-CPX3Y

changement de mot de passe

	net user <nom> <newpasswd>
	
ajout de group

	net localgroup group_name UserLoginName /add
	
Verifier les permissions d'un users: 
	properties-> advanced -> effective permissions

Repliquer des liens DFS:

	dfscmd /add \\cront139\drive\equipement\METRODEF\backup_equipement\FAXIO \\c2na04.cr2.st.com\QS93$\current\FAXIO
	dfscmd /remove \\server\share[\path...] \\server\share[\path...]

Rappel Divers
Spaning tree: niveau 2 -> une racine par reseaux
firewall peut etre de niveau 2

HP smart array le nouveau menu des model HP g8 est beaucoup plus simple F8 / si non F5 au d�marrage: ancien menu (type BIOS)

empecher windows de passer en adresse APIPA
new-ItemProperty -path registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name "IPAutoconfigurationEnabled" -value 0

GPO: rsop.msc -> ATTENTION apres changement d'OU les parametre de l'ancienne GPO ne disparaisse pas forcement !!!

Remarque sur le Deny:
It matters in so much as Deny privileges take precedence over Allow. If your Users have a Deny permissions on anything, their Administrator membership will not allow them access to the resource. You can test this on Users by creating a deny permission to list contents of a folder, you will get the following warning dialog:

Connaitre rapidement les droit d'un fichier/dossier: get-acl \\c2wapc.cr2.st.com\n0161$\STLithoSrvFiles).access |format-list

Gerer les objet AD: adsiedit.msc

Tester la connection avec le controleur de domaine:
nltest /sc_query:<domain>


pour le suffixe cr2.st.com dans le domaine st; la GPO force le cro.st.com, il faut en �diter aevec: 
	administrative template -> network -> Disabled: register DNS records with connection-specific DNS suffix
	
changement clavier:
Set-WinUserLanguageList -LanguageList [en-US |fr-FR ]

Niveau d'authentification remote desktop:
GPO locale (si pas appliqu� par GPO) -> Security Options -> Network Security: LAN manager

remote desktop: mstsc

desactiver autorun:
Method 1
1.Click Start -> Run type Gpedit.msc and then press ENTER. 
2.Under Computer Configuration, expand Administrative Templates, expand Windows Components, and then click Autoplay Policies. 
3. In the Details pane, double-click Turn off Autoplay. 
4.Click Enabled, and then select All drives in the Turn off Autoplay box to disable Autorun on all drives. 
5.Restart the computer. 
Method 2
1.Click Start -> Run type Gpedit.msc and then press ENTER. 
2.Under Computer Configuration, expand Administrative Templates, expand Windows Components, and then click Autoplay Policies. 
3.In the Details pane, double-click Default Behavior for AutoRun. 
4.Click Enabled, and then select Do not execute any autorun commands in the Default Autorun behavior box to disable Autorun on all drives. 
5.Restart the computer. 

Analyser les performances:
demarrer -> executer -> perfmon 


patch wanncry:
	https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
	
	check:
	$hotfixes = 'KB4012212', 'KB4012217', 'KB4015551', 'KB4019216', 'KB4012216', 'KB4015550', 'KB4019215', 'KB4013429', 'KB4019472', 'KB4015217', 'KB4015438', 'KB4016635','KB4012598' ; Get-HotFix  -id $hotfixes 

probleme d'acc�s aux partages SMB: regarder cot� serveur la cles: "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters": disablestrictnamechecking 1 


