# bloodhound

## disclaimer

Utiliser BloodHound implique de collecter l’ensemble des données d’un Active Directory cible via un outil (LDAP) et de les réimporter dans des fichiers et une BDD non sécurisée par défaut.

## install

```sh
sudo apt install bloodhound

Change the Default Password for Neo4j
We really should change the default password for Neo4j, you know.. For reasons.
Let’s launch Neo4j
neo4j console


sudo neo4j console

Active database: graph.db
Directories in use:
  home:         /usr/share/neo4j
  config:       /usr/share/neo4j/conf
  logs:         /usr/share/neo4j/logs
  plugins:      /usr/share/neo4j/plugins
  import:       /usr/share/neo4j/import
  data:         /usr/share/neo4j/data
  certificates: /usr/share/neo4j/certificates
  run:          /usr/share/neo4j/run
Starting Neo4j.
WARNING: Max 1024 open files allowed, minimum of 40000 recommended. See the Neo4j manual.
2019-10-17 18:59:39.348+0000 INFO  ======== Neo4j 3.5.3 ========
2019-10-17 18:59:39.359+0000 INFO  Starting...
2019-10-17 18:59:41.817+0000 INFO  Bolt enabled on 127.0.0.1:7687.
2019-10-17 18:59:43.400+0000 INFO  Started.
2019-10-17 18:59:44.437+0000 INFO  Remote interface available at http://localhost:7474/



Let the Hound See The Blood
Pop a new terminal window open and run the following command to  launch Bloodhound, leave the Neo4j console running for obvious reasons.

bloodhound

As you can see, Bloodhound is now running and waiting for some user  input. Earlier when launching Neo4j it also enabled Bolt on  bolt://127.0.0.1:7687. You need to use this as your Database URL.
• Database URL – bolt://127.0.0.1:7687
• Username – neo4j
• Password – your newly changed password



Il faut ensuite importer SharpHound sur la machine de la Victime

Sharphound.exe ...

ou 

utiliser un client python distant

./bloodhound.py -u svc-alfresco -d HTB.LOCAL -p s3rvice -dc 10.10.10.161 -gc 10.10.10.161
 
 INFO: Connecting to LDAP server: 10.10.10.161
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: 10.10.10.161
INFO: Found 31 users
INFO: Connecting to GC LDAP server: 10.10.10.161
INFO: Found 72 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: FOREST.htb.local
INFO: Querying computer: EXCH01.htb.local
INFO: Skipping enumeration for FOREST.htb.local since it could not be resolved.
INFO: Skipping enumeration for EXCH01.htb.local since it could not be resolved.
INFO: Done in 00M 22S
```
 
Vous pouvez également utiliser ce docker compose pour lancer BloodHound:
```yaml
# Copyright 2023 Specter Ops, Inc.
#
# Licensed under the Apache License, Version 2.0
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

version: '3'
services:
  app-db:
    image: docker.io/library/postgres:13.2
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-bloodhound}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-bloodhoundcommunityedition}
      - POSTGRES_DB=${POSTGRES_DB:-bloodhound}
    # Database ports are disabled by default. Please change your database password to something secure before uncommenting
    # ports:
    #   - ${POSTGRES_PORT:-5432}:5432
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-bloodhound} -d ${POSTGRES_DB:-bloodhound} -h 127.0.0.1 -p 5432"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  graph-db:
    image: docker.io/library/neo4j:4.4
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/bloodhoundcommunityedition}
      - NEO4J_dbms_allow__upgrade=${NEO4J_ALLOW_UPGRADE:-true}
    # Database ports are disabled by default. Please change your database password to something secure before uncommenting
    # ports:
    #   - ${NEO4J_DB_PORT:-7687}:7687
    #   - ${NEO4J_WEB_PORT:-7474}:7474
    volumes:
      - ${NEO4J_DATA_MOUNT:-neo4j-data}:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -O /dev/null -q http://localhost:${NEO4J_WEB_PORT:-7474} || exit 1"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  bloodhound:
    image: docker.io/specterops/bloodhound:${BLOODHOUND_TAG:-latest}
    environment:
      - bhe_disable_cypher_qc=${bhe_disable_cypher_qc:-false}
      ### Add additional environment variables you wish to use here.
      ### For common configuration options that you might want to use environment variables for, see `.env.example`
      ### example: bhe_database_connection=${bhe_database_connection}
      ### The left side is the environment variable you're setting for bloodhound, the variable on the right in `${}`
      ### is the variable available outside of Docker
    ports:
      - ${BLOODHOUND_PORT:-8080}:8080
    ### Uncomment to use your own bloodhound.config.json to configure the application
    # volumes:
    #   - ./bloodhound.config.json:/bloodhound.config.json:ro
    depends_on:
      app-db:
        condition: service_healthy
      graph-db:
        condition: service_healthy

volumes:
  neo4j-data:
  postgres-data:
```
Ou plus simplement, executer directement la commande suivante:
```shell
sudo curl -L https://ghst.ly/getbhce | sudo docker compose -f - up
````


on upload ensuite les donnée via la GUI



## SharpHound

ingestor pour collecter les données

```powershell
Powershell -exec bypass
Import-module SharpHound.ps1
Invoke-BloodHound -CollectionMethod ACL,ObjectProps,Default -CompressData –SkipPing
```


## Analyse

si les requetes par défaut ne suffice pas il éxiste des projets avec d'autres requetes (spécifiques)

ie: https://github.com/CompassSecurity/BloodHoundQueries

## training

https://github.com/davidprowe/BadBlood