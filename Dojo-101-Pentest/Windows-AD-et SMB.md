# Windows AD et SMB (reseau)


## Netexec

[NetExec](https://github.com/Pennyw0rth/NetExec)


## Responder

[Responder](https://github.com/lgandx/Responder)

### llmnr et netbios spoofing, netLM interception

```sh
sudo responder -I tun0
```

* log path: /usr/share/responder/logs/



## AD users

### enumeration des utilisateurs:

```sh
nmap --script smb-enum-users.nse -p 445 <host>
sudo nmap -sU -sS --script smb-enum-users.nse -p U:137,T:139 <host>
```

### ridenum (apt install)

#### Connect to the remote server (192.168.1.236) and cycle from RID 500 to 50000 (500 50000), using the given password file (/tmp/passes.txt):

```sh
ridenum 192.168.1.236 500 50000 /tmp/passes.txt
```
### impacket

```sh
/usr/share/doc/python3-impacket/examples/lookupsid.py HTB/svc-alfresco:s3rvice@10.10.10.161
```

#### sans authent

```sh
/usr/share/doc/python3-impacket/examples/GetADUsers.py  -all -no-pass -dc-ip 10.10.10.172 MEGABANK.LOCAL/
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

[*] Querying 10.10.10.172 for information about domain.
Name                  Email                           PasswordLastSet      LastLogon           
--------------------  ------------------------------  -------------------  -------------------
Guest                                                 <never>              <never>             
AAD_987d7f2f57d2                                      2020-01-02 23:53:24.984897  2020-01-13 20:26:39.751833 
mhope                                                 2020-01-03 00:40:05.908924  2020-01-03 14:29:59.037500 
SABatchJobs                                           2020-01-03 13:48:46.392235  2020-01-14 17:42:40.486176 
svc-ata                                               2020-01-03 13:58:31.332169  <never>             
svc-bexec                                             2020-01-03 13:59:55.863422  <never>             
svc-netapp                                            2020-01-03 14:01:42.786264  <never>             
dgalanos                                              2020-01-03 14:06:10.519660  <never>             
roleary                                               2020-01-03 14:08:05.832167  <never>             
smorgan                                               2020-01-03 14:09:21.629084  <never>             
```

#### SPN

```powershell
setspn
setspn -Q */*
```

## Enum4linux

```sh
Enum4linux <IP>
```

# Kerberos:

* sur le rzo: scanner les ports 88

* en local: `dsquery server`

## kerbute

```sh
 ./kerbrute_linux_amd64 userenum -d HTB.local --dc 10.10.10.161 user 

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.2 (fd5f345) - 10/15/19 - Ronnie Flathers @ropnop

2019/10/15 17:31:39 >  Using KDC(s):
2019/10/15 17:31:39 >  	10.10.10.161:88

2019/10/15 17:31:39 >  [+] VALID USERNAME:	 Administrator@HTB.local
2019/10/15 17:31:39 >  [+] VALID USERNAME:	 andy@HTB.local
2019/10/15 17:31:39 >  [+] VALID USERNAME:	 lucinda@HTB.local
2019/10/15 17:31:39 >  [+] VALID USERNAME:	 mark@HTB.local
2019/10/15 17:31:39 >  [+] VALID USERNAME:	 santi@HTB.local
2019/10/15 17:31:39 >  [+] VALID USERNAME:	 sebastien@HTB.local
2019/10/15 17:31:39 >  [+] VALID USERNAME:	 svc-alfresco@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 EXCH01$@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailbox0659cc1@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailbox6ded678@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailbox7108a4e@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailbox83d6781@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailbox968e74d@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailboxb01ac64@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailboxc0a90c9@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailboxc3d7722@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailboxfc9daad@HTB.local
2019/10/15 17:31:40 >  [+] VALID USERNAME:	 HealthMailboxfd87238@HTB.local
2019/10/15 17:31:40 >  Done! Tested 32 usernames (18 valid) in 0.461 seconds
```


## LDAP

```sh
sudo nmap -p 389 --script ldap-brute --script-args ldap.base='"cn=users,dc=megabank,dc=local"' 10.10.10.172
```

### une fois qu'on a un compte:

```sh
ldapdomaindump -u DANTE.LOCAL\\mrb3n -p Welcome1 172.16.1.20
```


## NETBIOS

```sh
nbtscan 192.168.1.1/24  
nmblookup -A 10.10.10.161
```


## RPC

### samrdump.py: An  application that communicates with the Security Account Manager(SAM)  Remote interface from the MSRPC suite. 

```sh
/usr/share/doc/python3-impacket/examples/samrdump.py 10.10.10.161
```

### lookupsid.py: This script allows you to bruteforce the Windows SID through [MS-LSAT] MSRPC Interface, aiming at finding remote users/groups.

```sh
/usr/share/doc/python3-impacket/examples/lookupsid.py user:motdepasse@10.10.10.149
```


### autres:

```
nmap <target> --script=msrpc-enum

rpcclient -U "" -N 192.168.1.102

enumdomusers

queryuser 0x3e8
```


## smbclient


### enumeration des share smb:

```sh
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse <host>
nmap -p 445 --script smb-os-discovery <host>
nmap -sV -p 445 --script smb-brute <host>
nmap --script smb-vuln* -p 139,445 <host>
```

### smbmap

```sh
smbmap -H 10.10.10.161
smbmap -u test -H 172.16.1.101
```

### impacket:

```sh
proxychains impacket-smbclient 172.16.1.17
```

```sh
/usr/share/doc/python3-impacket/examples/smbclient.py HTB/svc-alfresco:s3rvice@10.10.10.161
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

Type help for list of commands
# shares
ADMIN$
C$
IPC$
NETLOGON
SYSVOL

#use <share>
#ls
#get

#smbclient
smbclient -L 192.168.1.102
smbclient //192.168.1.102/tmp       
smbclient --user=Hazard -L 10.10.10.149
smbclient -L \\HTB -I 10.10.10.161 -N
```


## RDP

### linux client

#### rdesktop

```sh
rdesktop <IP>
```

#### xfreerdp

```sh
xfreerdp /u:admin /p:password /cert:ignore /v:MACHINE_IP /workarea
```

#### remmina

```sh
sudo remmina
```
### Windows

```powershell
mstsc.exe
```

### Alternatives

[PsMapExec](https://github.com/The-Viper-One/PsMapExec)