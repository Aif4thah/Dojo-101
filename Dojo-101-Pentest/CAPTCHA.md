# CAPTCHA

## Definitions

* OCR : Optical Character Recognition

### Types de CAPTCHA

| Type                         | Exemple                       | Détail                            |
|-----------------------------|-------------------------------|------------------------------------|
| Texte déformé (Image)       | `X7Fp3` avec distorsions      | Classique, utilisé avec OCR       |
| CAPTCHA mathématique        | "3 + 5 = ?"                   | Parfois simple regex suffit       |
| CAPTCHA logique ou question | "Le soleil est : chaud ou froid ?" | Peut être résolu par NLP       |
| CAPTCHA audio               | Lecture vocale d’un code      | OCR appliqué à la transcription   |
| reCAPTCHA v2 / v3 (Google)  | "Je ne suis pas un robot"     | JavaScript + analyse comportementale |
| CAPTCHA avec puzzle         | Glisser pour assembler une pièce | Basé sur image interactive       |

---

### Techniques de contournement

-  **OCR (Optical Character Recognition)** pour les CAPTCHA image
-  **Machine Learning / Deep Learning** sur datasets CAPTCHA (CNN, Keras, PyTorch)
-  **Analyse du HTML** : parfois le champ est en clair dans le DOM ou via JS
-  **Désactivation JS** (certains CAPTCHA sont 100% JS)
-  **Brute-force + Regex** (CAPTCHA faible ou prévisible)
-  **Prétraitement d’image** (binarisation, filtre, seuils)

---

### Outils OCR

- [pytesseract](https://pypi.org/project/pytesseract/) — *OCR Python avec moteur Tesseract*
- [Google Vision API](https://cloud.google.com/vision/docs/ocr) — *OCR cloud précis (payant au-delà d’un quota)*
- [EasyOCR](https://github.com/JaidedAI/EasyOCR) — *OCR moderne basé sur PyTorch*
- [ABBYY FineReader](https://www.abbyy.com/en-eu/finereader/) — *OCR commercial professionnel*

## Exemple de contournement

Packages nécessaires :

```sh
pip install requests beautifulsoup4 pillow pytesseract
sudo apt install tesseract-ocr 
```

Exemple de script qui résout un CAPTCHA dans une image en `base64` : 

```python
import requests
from bs4 import BeautifulSoup
import base64
from PIL import Image, ImageFilter
from io import BytesIO
import pytesseract
import time

# URL du challenge
url = "http://exemple.lan"
session = requests.Session()

def brute_force_ocr(image_data):
    """
    Essaie plusieurs niveaux de binarisation et modes OCR pour maximiser les chances de décoder le CAPTCHA.
    """
    image = Image.open(BytesIO(image_data)).convert("L")  # Grayscale

    for threshold in range(120, 181, 20):
        # Binarisation
        bin_img = image.point(lambda p: 255 if p > threshold else 0)
        bin_img = bin_img.filter(ImageFilter.MedianFilter())  # Nettoyage du bruit

        # Sauvegarde pour debug
        bin_img.save(f"captcha_cleaned_thr{threshold}.png")

        for psm in [7, 8, 6]:
            config = f'--psm {psm} --oem 3 -c tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
            text = pytesseract.image_to_string(bin_img, config=config).strip()
            if text and len(text) >= 4:
                print(f"[DBG] OCR (thr={threshold}, psm={psm}): {text}")
                return text
    return ""

def solve_captcha():
    start = time.time()

    # Récupération de la page HTML
    response = session.get(url)
    soup = BeautifulSoup(response.text, "html.parser")

    # Extraction de l’image CAPTCHA en base64
    img_tag = soup.find("img")
    img_data_base64 = img_tag['src'].split(",")[1]
    img_data = base64.b64decode(img_data_base64)

    # Sauvegarde de l'image brute pour debug
    with open("captcha_raw.png", "wb") as f:
        f.write(img_data)

    # OCR amélioré
    captcha_text = brute_force_ocr(img_data)
    print(f"[+] CAPTCHA lu : {captcha_text}")

    # Soumission du CAPTCHA
    payload = {'cametu': captcha_text}
    response = session.post(url, data=payload)

    # Vérifie s’il y a un flag
    print(response.text)

    elapsed = time.time() - start
    print(f"[⏱] Temps total : {elapsed:.2f} secondes")

if __name__ == "__main__":
    solve_captcha()
```